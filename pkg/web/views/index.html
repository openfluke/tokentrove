<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .gradient-text { background: linear-gradient(135deg, #6366f1 0%, #f43f5e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <header class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <h1 class="text-xl font-bold gradient-text cursor-pointer" onclick="showView('main')">üîÆ TokenTrove</h1>
            <div class="flex items-center gap-3">
                <input type="text" id="searchInput" placeholder="Search..." class="w-48 bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm">
                <span id="wsStatus" class="text-xs text-gray-400">...</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Main View -->
        <div id="mainView">
            <div class="grid grid-cols-4 gap-3 mb-6">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <p class="text-gray-400 text-xs">Words</p>
                    <p class="text-xl font-bold text-indigo-400">{{.WordCount}}</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <p class="text-gray-400 text-xs">Files</p>
                    <p class="text-xl font-bold text-emerald-400">{{.FileCount}}</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <p class="text-gray-400 text-xs">Max N</p>
                    <p class="text-xl font-bold text-amber-400">{{.MaxN}}</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <p class="text-gray-400 text-xs">2-grams</p>
                    <p class="text-xl font-bold text-pink-400" id="stat2gram">-</p>
                </div>
            </div>

            <div id="searchResults" class="hidden mb-6 bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="flex justify-between mb-3">
                    <span class="font-medium">üîç Results</span>
                    <button onclick="closeSearch()" class="text-gray-400">‚úï</button>
                </div>
                <div id="searchContent"></div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div class="col-span-2">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="font-medium">üìä N-grams</span>
                        <span class="text-xs text-gray-500">(streamed)</span>
                    </div>
                    <div class="flex gap-1 mb-3 flex-wrap" id="ngramTabs"></div>
                    <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
                        <div id="ngramList" class="divide-y divide-gray-800 max-h-80 overflow-y-auto text-sm"></div>
                    </div>
                    <div class="flex justify-center gap-3 mt-3 text-sm" id="pagination"></div>
                </div>

                <div>
                    <span class="font-medium mb-3 block">üìë Reports</span>
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-3 space-y-3">
                        <div class="border-b border-gray-800 pb-3">
                            <select id="reportType" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-sm mb-2">
                                <option value="top_ngrams">Top N-grams Summary</option>
                                <option value="search">Search Report</option>
                                <option value="recurring_text">üî• Recurring Text Finder</option>
                                <option value="linked_ngrams">üîó Most Linked N-grams</option>
                                <option value="best_chains">üèÜ Best Chains (auto-find longest)</option>
                            </select>
                            <input id="reportQuery" placeholder="Query (for search)" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-sm mb-2 hidden">
                            <div id="recurringOptions" class="hidden space-y-2 mb-2">
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">Min N-gram:</label>
                                        <select id="minN" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-sm">
                                            <option value="3">3 words</option>
                                            <option value="5" selected>5 words</option>
                                            <option value="7">7 words</option>
                                            <option value="10">10 words</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Min Files:</label>
                                        <select id="minFiles" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-sm">
                                            <option value="2" selected>2+ files</option>
                                            <option value="5">5+ files</option>
                                            <option value="10">10+ files</option>
                                            <option value="50">50+ files</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Top N:</label>
                                        <input type="number" id="topN" value="10" min="1" max="1000" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-sm">
                                    </div>
                                </div>
                                <label class="flex items-center gap-2 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" id="skipNumeric" checked class="rounded bg-gray-800 border-gray-600">
                                    Skip numeric patterns (hide 7 7 7, 0 0 0, etc.)
                                </label>
                            </div>
                            <button onclick="queueReport()" class="w-full bg-indigo-600 text-white rounded px-3 py-1.5 text-sm font-medium hover:bg-indigo-500">
                                Generate Report
                            </button>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 mb-2">Recent Jobs</p>
                            <div id="jobsList" class="space-y-1 max-h-64 overflow-y-auto text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report View -->
        <div id="reportView" class="hidden">
            <div class="flex items-center gap-3 mb-4">
                <button onclick="showView('main')" class="text-gray-400 hover:text-white">‚Üê Back</button>
                <div>
                    <span class="font-medium" id="reportTitle">Report</span>
                    <p class="text-xs text-gray-400" id="reportDesc"></p>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div id="reportProgress" class="hidden mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span id="progressMessage">Processing...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2">
                        <div id="progressBar" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div id="reportContent" class="text-sm"></div>
            </div>
        </div>
    </main>

    <script>
        let ws, stats, currentN = 2, offset = 0;
        const limit = 30;

        document.getElementById('reportType').onchange = (e) => {
            document.getElementById('reportQuery').classList.toggle('hidden', e.target.value !== 'search');
            document.getElementById('recurringOptions').classList.toggle('hidden', !['recurring_text', 'linked_ngrams', 'best_chains'].includes(e.target.value));
        };

        function showView(v) {
            document.getElementById('mainView').classList.toggle('hidden', v !== 'main');
            document.getElementById('reportView').classList.toggle('hidden', v !== 'report');
        }

        function connectWS() {
            ws = new WebSocket(`ws://${location.host}/ws`);
            ws.onopen = () => document.getElementById('wsStatus').innerHTML = '<span class="text-emerald-400">‚óè Live</span>';
            ws.onclose = () => { document.getElementById('wsStatus').innerHTML = '<span class="text-red-400">‚óè Off</span>'; setTimeout(connectWS, 3000); };
            ws.onmessage = (e) => handleMsg(JSON.parse(e.data));
        }

        function handleMsg(data) {
            if (data.type === 'stats') { stats = data; updateStats(); buildTabs(); requestNgrams(); }
            else if (data.type === 'ngrams') renderNgrams(data);
            else if (data.type === 'search') renderSearch(data);
        }

        function updateStats() {
            if (stats?.ngramCounts?.['2gram']) document.getElementById('stat2gram').textContent = stats.ngramCounts['2gram'].toLocaleString();
        }

        function buildTabs() {
            const c = document.getElementById('ngramTabs');
            c.innerHTML = '';
            for (let n = 2; n <= (stats?.maxN || 2); n++) {
                if ((stats?.ngramCounts?.[n+'gram'] || 0) > 0) {
                    const b = document.createElement('button');
                    b.className = `px-2 py-1 rounded text-xs ${n === currentN ? 'bg-indigo-600 text-white' : 'bg-gray-800'}`;
                    b.textContent = n + '-gram';
                    b.onclick = () => { currentN = n; offset = 0; buildTabs(); requestNgrams(); };
                    c.appendChild(b);
                }
            }
        }

        function requestNgrams() { ws?.send(JSON.stringify({ action: 'ngrams', n: currentN, limit, offset })); }

        function renderNgrams(data) {
            const c = document.getElementById('ngramList');
            c.innerHTML = (data.ngrams || []).map(ng => `
                <div class="flex justify-between px-3 py-2 hover:bg-gray-800/50">
                    <span class="mono">${ng.words?.join(' ¬∑ ') || ''}</span>
                    <span class="text-pink-400 text-xs">${ng.count?.toLocaleString()}</span>
                </div>
            `).join('') || '<div class="p-4 text-gray-400">No data</div>';

            const p = document.getElementById('pagination');
            const t = data.total || 0;
            p.innerHTML = `
                <button onclick="page(-1)" ${offset <= 0 ? 'disabled' : ''} class="px-2 py-1 bg-gray-800 rounded text-xs disabled:opacity-50">‚Üê</button>
                <span class="text-gray-400 text-xs">${offset+1}-${Math.min(offset+limit, t)} / ${t}</span>
                <button onclick="page(1)" ${offset+limit >= t ? 'disabled' : ''} class="px-2 py-1 bg-gray-800 rounded text-xs disabled:opacity-50">‚Üí</button>
            `;
        }

        function page(d) { offset = Math.max(0, offset + d * limit); requestNgrams(); }
        function search() { const q = document.getElementById('searchInput').value; if (q) ws?.send(JSON.stringify({ action: 'search', query: q })); }
        function renderSearch(data) {
            document.getElementById('searchResults').classList.remove('hidden');
            let h = '';
            if (data.words?.length) h += `<div class="mb-2">${data.words.map(w => `<span class="bg-gray-800 px-1.5 py-0.5 rounded text-xs mx-0.5">${w.word}</span>`).join('')}</div>`;
            for (let n = 2; n <= 15; n++) {
                if (data.ngrams?.[n]?.length) h += `<div class="mb-2"><span class="text-xs text-gray-400">${n}-gram:</span> ${data.ngrams[n].slice(0,3).map(ng => `<span class="bg-gray-800 px-1.5 py-0.5 rounded text-xs mx-0.5">${ng.words?.join(' ')}</span>`).join('')}</div>`;
            }
            document.getElementById('searchContent').innerHTML = h || '<span class="text-gray-400">No results</span>';
        }
        function closeSearch() { document.getElementById('searchResults').classList.add('hidden'); }

        async function queueReport() {
            const type = document.getElementById('reportType').value;
            const query = document.getElementById('reportQuery').value;
            const minN = parseInt(document.getElementById('minN').value);
            const minFiles = parseInt(document.getElementById('minFiles').value);
            const skipNumeric = document.getElementById('skipNumeric').checked;
            const topN = parseInt(document.getElementById('topN').value);
            const res = await fetch('/api/report', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type, query, minN, minFiles, skipNumeric, topN }) });
            const job = await res.json();
            showView('report');
            document.getElementById('reportTitle').textContent = job.name || job.type;
            document.getElementById('reportDesc').textContent = job.description || '';
            document.getElementById('reportProgress').classList.remove('hidden');
            document.getElementById('reportContent').innerHTML = '<span class="text-gray-400">Processing...</span>';
            pollJob(job.id);
            loadJobs();
        }

        async function pollJob(id) {
            const res = await fetch(`/api/report/${id}`);
            const job = await res.json();
            if (job.total > 0) {
                const pct = Math.round((job.progress / job.total) * 100);
                document.getElementById('progressBar').style.width = pct + '%';
                document.getElementById('progressPercent').textContent = pct + '%';
            }
            document.getElementById('progressMessage').textContent = job.message || job.status;
            if (job.status === 'running' || job.status === 'queued') setTimeout(() => pollJob(id), 1000);
            else if (job.status === 'done') loadReportContent(id);
            else if (job.status === 'error') document.getElementById('reportContent').innerHTML = `<span class="text-red-400">Error: ${job.error}</span>`;
        }

        function toggleFiles(id) {
            const el = document.getElementById('files-' + id);
            el.classList.toggle('hidden');
        }

        async function loadReportContent(id) {
            document.getElementById('reportProgress').classList.add('hidden');
            const res = await fetch(`/api/report/${id}/view`);
            const result = await res.json();
            
            if (result.data?.chains) {
                // Recurring text visualization
                let html = `<p class="mb-4 text-gray-400">${result.data.chainCount} recurring text patterns found (min ${result.data.minN}-gram)</p>`;
                html += '<div class="space-y-3">';
                
                result.data.chains.forEach((chain, idx) => {
                    const filesHtml = chain.files?.length 
                        ? chain.files.map(f => `<div class="py-1 px-2 bg-gray-900 rounded text-xs text-gray-300">${f}</div>`).join('')
                        : '<div class="text-gray-500 text-xs">No shared files found</div>';
                    
                    // Build highlighted text showing segments
                    const words = chain.fullText.split(' ');
                    const seg1 = chain.segments[0];
                    const seg2 = chain.segments[1];
                    
                    // Create highlighted spans for each word
                    // Segment 1 only: 0 to seg1.endIdx-2 (exclusive part)
                    // Overlap: seg1.endIdx-1 to seg1.endIdx (2 words)
                    // Segment 2 only: seg1.endIdx+1 to end
                    const overlapStart = seg1.n - 2;
                    const overlapEnd = seg1.n - 1;
                    
                    let highlightedText = '';
                    words.forEach((word, i) => {
                        if (i < overlapStart) {
                            // Segment 1 only (indigo)
                            highlightedText += `<span class="text-indigo-400">${word}</span> `;
                        } else if (i <= overlapEnd) {
                            // Overlap (amber with underline)
                            highlightedText += `<span class="text-amber-400 underline decoration-amber-400/50">${word}</span> `;
                        } else {
                            // Segment 2 only (emerald)
                            highlightedText += `<span class="text-emerald-400">${word}</span> `;
                        }
                    });
                    
                    html += `
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="mb-2 leading-relaxed">
                                ${highlightedText}
                            </div>
                            <div class="flex items-center gap-4 text-xs text-gray-400 mb-2">
                                <span>üìè ${chain.totalLength} words</span>
                                <span>üîó overlap: <span class="text-amber-400">"${chain.overlap}"</span></span>
                                <span>üìÅ <button onclick="toggleFiles(${idx})" class="text-emerald-400 hover:underline">${chain.fileCount} files</button></span>
                            </div>
                            <div class="text-xs mb-2 flex gap-2">
                                <span class="bg-indigo-900/50 text-indigo-300 px-1.5 py-0.5 rounded">${seg1.n}-gram (${seg1.count})</span>
                                <span class="text-gray-500">‚Üí</span>
                                <span class="bg-emerald-900/50 text-emerald-300 px-1.5 py-0.5 rounded">${seg2.n}-gram (${seg2.count})</span>
                            </div>
                            <div id="files-${idx}" class="hidden mt-2 max-h-40 overflow-y-auto space-y-1">
                                ${filesHtml}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('reportContent').innerHTML = html;
            } else if (result.data?.chains && result.data?.type === 'linked_ngrams') {
                // Linked chains visualization (A ‚Üí B ‚Üí C)
                let html = `<p class="mb-4 text-gray-400">${result.data.chainCount} n-gram chains (min ${result.data.minN}-gram, ${result.data.minFiles}+ files)</p>`;
                html += '<div class="space-y-3">';
                
                result.data.chains.forEach((chain, idx) => {
                    const filesHtml = chain.files?.length 
                        ? chain.files.map(f => `<div class="py-1 px-2 bg-gray-900 rounded text-xs text-gray-300">${f}</div>`).join('')
                        : '<div class="text-gray-500 text-xs">No file data</div>';
                    
                    // Color each segment
                    const segmentColors = ['text-indigo-400', 'text-amber-400', 'text-emerald-400'];
                    const chainLabels = chain.chain.map((node, i) => 
                        `<span class="bg-gray-700 px-1.5 py-0.5 rounded text-xs ${segmentColors[i] || 'text-gray-300'}">${node.n}-gram (${node.count})</span>`
                    ).join(' <span class="text-gray-500">‚Üí</span> ');
                    
                    html += `
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="mb-2 text-indigo-300 leading-relaxed">${chain.fullText}</div>
                            <div class="flex items-center gap-4 text-xs text-gray-400 mb-2">
                                <span>üìè ${chain.chainLength} linked</span>
                                <span>üìÅ <button onclick="toggleFiles(${idx + 1000})" class="text-emerald-400 hover:underline">${chain.fileCount} files</button></span>
                            </div>
                            <div class="text-xs mb-2">${chainLabels}</div>
                            <div id="files-${idx + 1000}" class="hidden mt-2 max-h-40 overflow-y-auto space-y-1">
                                ${filesHtml}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('reportContent').innerHTML = html;
            } else if (result.data?.chains && result.data?.type === 'best_chains') {
                // Best chains visualization (sorted by score)
                let html = `<p class="mb-4 text-gray-400">${result.data.chainCount} best chains found (sorted by files √ó words)</p>`;
                html += '<div class="space-y-3">';
                
                result.data.chains.forEach((chain, idx) => {
                    const filesHtml = chain.files?.length 
                        ? chain.files.map(f => `<div class="py-1 px-2 bg-gray-900 rounded text-xs text-gray-300">${f}</div>`).join('')
                        : '<div class="text-gray-500 text-xs">No file data</div>';
                    
                    // Color each segment
                    const colors = ['text-indigo-400', 'text-amber-400', 'text-emerald-400', 'text-pink-400', 'text-cyan-400'];
                    const chainLabels = chain.chain.map((node, i) => 
                        `<span class="bg-gray-700 px-1.5 py-0.5 rounded text-xs ${colors[i % colors.length]}">${node.n}-gram</span>`
                    ).join(' <span class="text-gray-500">‚Üí</span> ');
                    
                    html += `
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="mb-2 text-indigo-300 leading-relaxed">${chain.fullText}</div>
                            <div class="flex items-center gap-4 text-xs mb-2">
                                <span class="bg-gradient-to-r from-amber-500 to-pink-500 text-white px-2 py-0.5 rounded font-bold">üèÜ Score: ${chain.score}</span>
                                <span class="text-gray-400">üìè ${chain.wordCount} words</span>
                                <span class="text-gray-400">üìÅ <button onclick="toggleFiles(${idx + 2000})" class="text-emerald-400 hover:underline">${chain.fileCount} files</button></span>
                                <span class="text-gray-400">üîó ${chain.chain.length} linked</span>
                            </div>
                            <div class="text-xs mb-2">${chainLabels}</div>
                            <div id="files-${idx + 2000}" class="hidden mt-2 max-h-40 overflow-y-auto space-y-1">
                                ${filesHtml}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('reportContent').innerHTML = html;
            } else if (result.data) {
                let html = '';
                Object.keys(result.data).forEach(key => {
                    if (Array.isArray(result.data[key])) {
                        html += `<div class="mb-4"><h3 class="text-sm text-gray-400 mb-2">${key}</h3>`;
                        html += '<div class="space-y-1">' + result.data[key].slice(0, 30).map(item => `<div class="bg-gray-800 rounded px-3 py-2 flex justify-between"><span>${item.phrase || ''}</span><span class="text-pink-400">${item.count || ''}</span></div>`).join('') + '</div></div>';
                    }
                });
                document.getElementById('reportContent').innerHTML = html || '<pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
            } else if (result.text) {
                document.getElementById('reportContent').innerHTML = `<pre class="whitespace-pre-wrap text-xs">${result.text}</pre>`;
            }
        }

        async function loadJobs() {
            const res = await fetch('/api/reports');
            const data = await res.json();
            document.getElementById('jobsList').innerHTML = (data.jobs || []).slice(0, 10).map(j => `
                <div class="bg-gray-800 rounded px-2 py-1.5 cursor-pointer hover:bg-gray-700" onclick="viewJob('${j.id}')">
                    <div class="flex justify-between items-center">
                        <span class="truncate text-xs font-medium">${j.name || j.type}</span>
                        <span class="${j.status === 'done' ? 'text-emerald-400' : j.status === 'error' ? 'text-red-400' : 'text-yellow-400'} text-xs">${j.status}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">${j.description || ''}</p>
                </div>
            `).join('') || '<span class="text-gray-500 text-xs">No jobs</span>';
        }

        function viewJob(id) {
            showView('report');
            document.getElementById('reportProgress').classList.add('hidden');
            fetch(`/api/report/${id}`).then(r => r.json()).then(job => {
                document.getElementById('reportTitle').textContent = job.name || job.type;
                document.getElementById('reportDesc').textContent = job.description || '';
                if (job.status === 'done') loadReportContent(id);
                else if (job.status === 'running' || job.status === 'queued') { document.getElementById('reportProgress').classList.remove('hidden'); pollJob(id); }
            });
        }

        document.getElementById('searchInput').onkeypress = (e) => { if (e.key === 'Enter') search(); };
        connectWS();
        loadJobs();
        setInterval(loadJobs, 5000);
    </script>
</body>
</html>
